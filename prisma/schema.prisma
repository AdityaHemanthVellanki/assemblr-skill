generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ─── Auth & Org ───

enum OrgRole {
  OWNER
  ADMIN
  MEMBER
  VIEWER
}

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members      OrgUser[]
  integrations Integration[]
  rawEvents    RawEvent[]
  events       UniversalEvent[]
  actors       OrgActor[]
  clusters     WorkflowCluster[]
  skills       Skill[]
  auditLogs    AuditLog[]
}

model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  name         String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  memberships OrgUser[]
  auditLogs   AuditLog[]
}

model OrgUser {
  id        String   @id @default(uuid())
  orgId     String
  userId    String
  role      OrgRole  @default(MEMBER)
  createdAt DateTime @default(now())

  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([orgId, userId])
  @@index([orgId])
  @@index([userId])
}

// ─── Integrations ───

enum IntegrationSource {
  SLACK
  GITHUB
  HUBSPOT
  JIRA
  NOTION
  GOOGLE
  STRIPE
}

enum IntegrationStatus {
  PENDING
  CONNECTED
  DISCONNECTED
  ERROR
}

model Integration {
  id                   String            @id @default(uuid())
  orgId                String
  source               IntegrationSource
  status               IntegrationStatus @default(PENDING)
  composioConnectionId String?
  encryptedCredentials String?
  scopes               Json?
  lastSyncAt           DateTime?
  syncCursor           String?
  errorMessage         String?
  isActive             Boolean           @default(true)
  createdAt            DateTime          @default(now())
  updatedAt            DateTime          @updatedAt

  org Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([orgId, source])
  @@index([orgId])
  @@index([status])
}

// ─── Events ───

model RawEvent {
  id         String            @id @default(uuid())
  orgId      String
  source     IntegrationSource
  rawPayload Json
  receivedAt DateTime          @default(now())

  org        Organization    @relation(fields: [orgId], references: [id], onDelete: Cascade)
  normalized UniversalEvent?

  @@index([orgId])
  @@index([orgId, source])
  @@index([receivedAt])
}

model UniversalEvent {
  id         String            @id @default(uuid())
  orgId      String
  source     IntegrationSource
  eventType  String
  actorId    String?
  entityType String
  entityId   String
  timestamp  DateTime
  metadata   Json              @default("{}")
  rawEventId String            @unique
  createdAt  DateTime          @default(now())

  org      Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  rawEvent RawEvent     @relation(fields: [rawEventId], references: [id])
  actor    OrgActor?    @relation(fields: [actorId], references: [id])

  @@index([orgId])
  @@index([orgId, source])
  @@index([orgId, eventType])
  @@index([orgId, actorId])
  @@index([orgId, entityType, entityId])
  @@index([orgId, timestamp])
  @@index([timestamp])
}

// ─── Identity ───

model OrgActor {
  id               String   @id @default(uuid())
  orgId            String
  primaryEmail     String?
  displayName      String?
  slackId          String?
  githubId         String?
  hubspotId        String?
  jiraId           String?
  notionId         String?
  googleId         String?
  stripeCustomerId String?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  org    Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  events UniversalEvent[]

  @@unique([orgId, primaryEmail])
  @@index([orgId])
  @@index([orgId, slackId])
  @@index([orgId, githubId])
  @@index([orgId, hubspotId])
  @@index([orgId, jiraId])
  @@index([orgId, stripeCustomerId])
}

// ─── Workflows ───

model WorkflowCluster {
  id              String   @id @default(uuid())
  orgId           String
  anchorEventType String
  anchorSource    String
  eventSequence   Json
  frequency       Int      @default(0)
  entropyScore    Float    @default(0)
  confidenceScore Float    @default(0)
  status          String   @default("candidate")
  metadata        Json     @default("{}")
  detectedAt      DateTime @default(now())
  updatedAt       DateTime @updatedAt

  org       Organization       @relation(fields: [orgId], references: [id], onDelete: Cascade)
  instances WorkflowInstance[]
  skills    Skill[]

  @@index([orgId])
  @@index([orgId, anchorEventType])
  @@index([orgId, confidenceScore])
  @@index([orgId, status])
}

model WorkflowInstance {
  id            String   @id @default(uuid())
  orgId         String
  clusterId     String
  anchorEventId String
  eventIds      Json
  startTime     DateTime
  endTime       DateTime
  createdAt     DateTime @default(now())

  cluster WorkflowCluster @relation(fields: [clusterId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([clusterId])
}

// ─── Skills ───

model Skill {
  id          String   @id @default(uuid())
  orgId       String
  name        String
  description String?
  clusterId   String?
  status      String   @default("draft")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  org      Organization     @relation(fields: [orgId], references: [id], onDelete: Cascade)
  cluster  WorkflowCluster? @relation(fields: [clusterId], references: [id])
  versions SkillVersion[]

  @@index([orgId])
  @@index([orgId, status])
  @@index([clusterId])
}

model SkillVersion {
  id          String    @id @default(uuid())
  skillId     String
  version     Int
  isLatest    Boolean   @default(true)
  trigger     Json
  nodes       Json
  edges       Json
  conditions  Json      @default("[]")
  metadata    Json      @default("{}")
  createdAt   DateTime  @default(now())
  publishedAt DateTime?

  skill Skill @relation(fields: [skillId], references: [id], onDelete: Cascade)

  @@index([skillId])
  @@index([skillId, isLatest])
}

// ─── Audit ───

model AuditLog {
  id           String   @id @default(uuid())
  orgId        String
  userId       String
  action       String
  resourceType String
  resourceId   String
  details      Json     @default("{}")
  ipAddress    String?
  createdAt    DateTime @default(now())

  org  Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  user User         @relation(fields: [userId], references: [id])

  @@index([orgId])
  @@index([orgId, action])
  @@index([orgId, resourceType, resourceId])
  @@index([createdAt])
}
